---
layout: default
---

  {%- include chart-page.html -%}

  <script src="/prm-funnel/assets/js/deepmerge.min.js"></script>
  <script>
    const items = JSON.parse('{{page.items | jsonify}}');
    const colours = JSON.parse('{{page.colours | jsonify}}');
    const labels = JSON.parse('{{page.labels | jsonify}}');

    const links = JSON.parse('{{page.links | jsonify}}');
    let url = '{{ site.url }}';
    const baseUrl = '{{ site.baseurl }}';
    if (url.indexOf(baseUrl) < 0) {
      url = `${url}${baseUrl}/`;
    }

    var datasets = { "datasets":
            [{
                data: items,
                label: '{{page.timeframe}}',
                backgroundColor: colours,
            }],
            labels: labels
      };

    var config = {
      type: 'bar',
      data: datasets,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          position: 'top',
        },
        title: {
          display: true,
          text: '{{page.title}}'
        },
        animation: {
          animateScale: true,
          animateRotate: true
        },
        onClick: function(evt) {
            var activePoints = window.myDoughnut.getElementsAtEvent(evt);
            var anyPoint = activePoints[0];
            if (anyPoint && links) {
              let document = links[anyPoint._index];
              if (document && document.document_name) {
                let link = `${url}charts/${document.document_name}.html`;
                window.location.href = link;
              }
            }
          },
          hover: {
            onHover: function(evt) {
              var point = this.getElementAtEvent(evt);
              if (point.length && links) {
                let document = links[point[0]._index];
                if (document && document.document_name) {
                  evt.target.style.cursor = 'pointer';
                } else {
                  evt.target.style.cursor = 'default';
                }
              }
            }
        },
        tooltips: {
          callbacks: {
            label: function(tooltipItem, data) {
              var dataset = data.datasets[tooltipItem.datasetIndex];
              var total = dataset.data.reduce(function(previousValue, currentValue, currentIndex, array) {
                return previousValue + currentValue;
              });
              var currentValue = dataset.data[tooltipItem.index];
              var percentage = Math.floor(((currentValue/total) * 100)+0.5);
              return `${currentValue} (${percentage}%)`;
            }
          }
        } 
      }
    };

    const pageChartConfig = JSON.parse('{{page.chart_config | jsonify}}') || {};
    const mergedChartConfig = deepmerge(config, pageChartConfig);

    window.onload = function() {
      var ctx = document.getElementById('chart-area').getContext('2d');
      window.myDoughnut = new Chart(ctx, mergedChartConfig);
    };

  </script>
  <script src="/prm-funnel/assets/js/Chart.min.js"></script>

